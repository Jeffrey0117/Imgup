# UpImg NextJS 專案計劃

## 🎯 專案概述

UpImg 是一個圖片上傳與短網址生成服務，支援批次上傳、預覽頁面、以及智能路由（根據 Accept header 判斷回傳圖片或 HTML）。

## 🔧 核心架構

### 智能路由設計

- **問題**: `duk.tw/hash` 既要作為預覽頁，又要支援 `<img src="duk.tw/hash">` 直接引用
- **解決方案**: Accept Header 判斷
  - 瀏覽器訪問 (`text/html`) → 302 redirect 到 `/hash/p` 預覽頁
  - 圖片標籤 (`image/*`) → 直接回傳圖片檔案

### 技術棧

- **前端**: Next.js 14, React, TypeScript, CSS Modules
- **後端**: Next.js API Routes, Prisma ORM
- **資料庫**: (待確認 - PostgreSQL/SQLite)
- **測試**: Jest, React Testing Library
- **部署**: Vercel

## 📋 當前狀態 (v1.3.1)

### ✅ 已完成功能

#### v1.0.0 - 基礎功能

- [x] 圖片上傳核心功能
- [x] 基礎 UI 介面
- [x] 檔案儲存邏輯

#### v1.1.0 - UI/UX 改善

- [x] 批次上傳 UI/UX
  - 鴨子動畫持續顯示
  - 整體批次進度條
  - 批次完成統計
- [x] 受控併發上傳 (預設並發數: 3)
- [x] 個別圖片進度條
- [x] UI 強化 (紫色漸層按鈕、微動效)

#### v1.2.0 - 測試與品質

- [x] 測試覆蓋 (Jest 6/6 套件, 35/35 測試通過)
- [x] 元件單元測試
- [x] 工具函數測試

#### v1.3.0 - 智能路由 (2025-09-20)

- [x] 智能路由系統
  - Accept Header 判斷邏輯
  - 瀏覽器請求 → 預覽頁面重定向
  - 圖片請求 → 直接圖片重定向
  - API 請求 → JSON 回應
- [x] 優化短網址生成算法
  - 5-6 字元長度 (替代原 11 字元)
  - 防碰撞機制
  - 向後相容性支援
- [x] Vercel.json rewrites 配置
- [x] 智能路由 API 端點實作

### 🐛 待修復問題

#### 高優先級

- [ ] **上傳時間顯示錯誤**
  - 問題描述：上傳後的時間戳記可能顯示不正確
  - 調查重點：
    - 時區處理邏輯 (`src/app/api/upload/route.ts`)
    - 前端時間格式化 (`src/app/page.tsx`)
    - UTC 與本地時間轉換
  - 相關檔案：
    - `/api/upload/route.ts` - 時間戳記生成
    - 前端顯示元件 - 時間格式化邏輯

#### 中優先級

- [ ] **手機版按鈕設計優化**
  - 問題描述：行動裝置上按鈕布局不理想
  - 需求細節：
    - **垂直排列時**：按鈕應更寬，且保持同寬
    - **水平排列時**：按鈕應更整齊對齊
    - **開始上傳按鈕**：需要適當的動畫效果（輕微漂浮感）
  - 相關檔案：
    - `src/app/page.module.css` - 按鈕樣式
    - 響應式設計斷點調整
    - 動畫效果實作 (CSS animations)

### 🔄 進行中

- [ ] 文件更新 (README + 智能路由說明)
- [ ] 修復上述問題

### ⏳ 待開發功能

- [ ] v1.4.0 短網址服務功能

## 🗓️ 版本歷程與規劃

### 已發布版本

#### v1.0.0 - 基礎版本 (2025-09-01)

- [x] 圖片上傳核心功能
- [x] 基礎 UI 介面
- [x] 檔案儲存邏輯

#### v1.1.0 - UI/UX 改善 (2025-09-10)

- [x] 批次上傳功能
- [x] 鴨子動畫
- [x] 進度條系統

#### v1.2.0 - 測試與品質 (2025-09-15)

- [x] 完整測試覆蓋
- [x] 程式碼重構

#### v1.3.0 - 智能路由 ✅ (2025-09-20)

- [x] 實作 Accept Header 判斷邏輯
- [x] 修改 `[hash]/route.ts` 支援圖片直接回傳
- [x] 新增 `[hash]/p/page.tsx` 預覽頁面
- [x] 短網址生成算法優化 (5-6 字元)
- [x] 防碰撞機制實作
- [x] 測試用例更新 (路由判斷)
- [x] 完整測試覆蓋 (35/35 通過)

### 即將發布

#### v1.3.1 - Bug 修復 (目標: 2025-09-25)

- [ ] 修復上傳時間顯示問題
- [ ] 優化手機版按鈕設計
- [ ] 新增上傳按鈕動畫效果

#### v1.4.0 - 短網址服務 (目標: 2025-10-01)

- [ ] 短網址 API 端點
- [ ] 短網址資料庫設計
- [ ] QR Code 生成優化
- [ ] 短網址管理 UI

#### v2.0.0 - 進階功能 (目標: 2025-10-15)

- [ ] 使用者認證系統
- [ ] 自訂別名功能
- [ ] 訪問統計
- [ ] 批次管理

## 🧪 測試策略

### 單元測試

- **工具**: Jest + React Testing Library
- **覆蓋範圍**:
  - 元件測試: `DuckAnimation`, `QRCode`
  - 工具函數: `hash.ts`, `storage.ts`
- **目標**: 維持 90%+ 測試覆蓋率

### 整合測試

- **API 端點測試**: `/api/upload`, `/api/shorten`, `/api/mapping`
- **路由測試**: Accept Header 判斷邏輯
- **檔案上傳測試**: 單張、批次、錯誤處理

### 手動測試矩陣

```
[ ] 單張圖片上傳
[ ] 批次圖片上傳 (2-10張)
[ ] 網路中斷情境
[ ] API 失敗處理
[ ] 批次完成提示
[ ] 並發限制驗證
[ ] 進度條準確性
[ ] 響應式設計 (手機/桌面)
```

## 📁 檔案結構

```
src/
├── app/
│   ├── [hash]/
│   │   ├── page.tsx           # 智能路由邏輯
│   │   ├── page.module.css
│   │   └── p/                 # 預覽頁面 (待實作)
│   │       └── page.tsx
│   ├── api/
│   │   ├── upload/route.ts    # 圖片上傳 API
│   │   ├── shorten/route.ts   # 短網址 API
│   │   └── mapping/[hash]/route.ts
│   └── page.tsx               # 主頁面
├── components/
│   ├── DuckAnimation.tsx      # 上傳動畫
│   ├── QRCode.tsx            # QR Code 生成
│   ├── ExpirySettings.tsx    # 過期設定
│   └── PasswordSettings.tsx  # 密碼保護
├── utils/
│   ├── hash.ts               # Hash 生成/驗證
│   └── storage.ts            # 檔案儲存邏輯
└── lib/
    └── prisma.ts             # 資料庫連接
```

## 🚀 部署清單

### 環境變數檢查

- [ ] `DATABASE_URL`
- [ ] `NEXTAUTH_SECRET`
- [ ] `STORAGE_API_KEY`
- [ ] `DOMAIN_URL`

### 效能優化

- [ ] 圖片壓縮設定
- [ ] CDN 配置
- [ ] 快取策略 (Browser/CDN)
- [ ] 資料庫連接池

### 監控設置

- [ ] 錯誤追蹤 (Sentry)
- [ ] 效能監控 (Vercel Analytics)
- [ ] 上傳成功率統計
- [ ] API 回應時間監控

## 🎨 未來功能擴展

### 使用者體驗

- [ ] 深色/淺色主題切換
- [ ] 多語言支援 (i18n)
- [ ] 拖曳上傳預覽
- [ ] 圖片壓縮選項

### 企業功能

- [ ] 使用者認證與權限
- [ ] 自訂網域支援
- [ ] API 限流與配額
- [ ] 白牌化選項

### 整合功能

- [ ] 社群媒體分享
- [ ] Markdown/HTML 嵌入工具
- [ ] 第三方儲存整合 (AWS S3, Cloudinary)
- [ ] Webhook 通知

## 🔍 當前優先任務

1. **緊急修復** (本週)

   - 調查並修復上傳時間顯示問題
   - 優化手機版按鈕布局
   - 實作上傳按鈕動畫效果

2. **立即執行** (本週)

   - 完成手動測試矩陣
   - 更新 README 文件
   - 推送當前變更
   - 發布 v1.3.1 修復版本

3. **短期目標** (2 週內)

   - 短網址服務基礎功能
   - QR Code 優化

4. **中期目標** (1 個月內)

   - 使用者認證系統
   - 基礎統計功能

## 📝 開發注意事項

### 程式碼品質

- 遵循 TypeScript 嚴格模式
- 元件採用 CSS Modules
- API 回應統一格式
- 錯誤處理標準化

### 效能考量

- 圖片上傳並發控制 (預設 3)
- 檔案大小限制 (待設定)
- 資料庫查詢優化
- 前端資源懶載入

### 安全性

- 檔案類型驗證
- 上傳大小限制
- XSS 防護
- CSRF 保護
- 速率限制

## 🔨 修復追蹤

### 問題 #1: 上傳時間顯示錯誤

- **狀態**: 🔴 待修復
- **優先級**: 高
- **影響範圍**: 所有使用者
- **調查項目**:
  - [ ] 檢查 `/api/upload/route.ts` 時間戳記生成
  - [ ] 檢查前端時間格式化函數
  - [ ] 驗證時區轉換邏輯
  - [ ] 測試不同時區情境

### 問題 #2: 手機版按鈕設計

- **狀態**: 🟡 待優化
- **優先級**: 中
- **影響範圍**: 行動裝置使用者
- **實作項目**:
  - [ ] 調整垂直排列按鈕寬度
  - [ ] 優化水平排列對齊
  - [ ] 新增上傳按鈕漂浮動畫
  - [ ] 測試不同螢幕尺寸

---

**最後更新**: 2025-09-20
**當前版本**: v1.3.0
**下個版本**: v1.3.1 (Bug 修復)
**下次檢查**: 2025-09-22
